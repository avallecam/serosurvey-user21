---
title: "serosurvey: Serological Surveys and Prevalence Estimation Under Misclassification"
# subtitle: "⚔<br/>with xaringan"
author: "Andree Valle-Campos (@avallecam)"
institute: "Centro Nacional de Epidemiología - CDC Perú"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["useR", "useR-fonts"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

<!-- class: chapter-slide -->

class: center, middle

# slides:<br/>[bit.ly/serosurvey-user21](https://bit.ly/serosurvey-user21)

---

# Introduction (1/2)

--

- Population-based serological surveys __generate__ seroprevalence estimates and __quantify__ how many people have been infected by a certain pathogen.

--

- These studies need to estimate prevalence considering __misclassification__ due to imperfect diagnostic tests with sensitivity and specificity __known with certainty__.

--

- However, during __first months__ of a novel pathogen outbreak, performance of diagnostic tests are __“unknown” or “uncertain”__ given limited validation studies.

--

.footnote[
[1] Takahashi, S., Greenhouse, B., & Rodríguez-Barraquer, I. (2020). Are SARS-CoV-2 seroprevalence estimates biased?. _The Journal of Infectious Diseases_. https://doi.org/10.1093/infdis/jiaa523

[2] Flor, Matthias, Michael Weiß, Thomas Selhorst, Christine Müller-Graf, and Matthias Greiner. 2020. “Comparison of Bayesian and Frequentist Methods for Prevalence Estimation Under Misclassification.” BMC Public Health 20 (1). https://doi.org/10.1186/s12889-020-09177-4.

[3] Kritsotakis, Evangelos I. 2020. “On the Importance of Population-Based Serological Surveys of SARS-CoV-2 Without Overlooking Their Inherent Uncertainties.” _Public Health in Practice_ 1 (November): 100013. https://doi.org/10.1016/j.puhip.2020.100013.
]

---

# Introduction (2/2)

--

- This situation opened the opportunity for the development of newer __ad-hoc methods__. Most of them used R, but not stored in a __R package__.

--

- The __increased demand__ for prevalence estimates and the absence of standardized procedures favored the usage of __non-reproducible workflows__.

--

- We created the __serosurvey R package__ to gather Serological Survey Analysis (known and recently developed) __functions__ and __workflow__ templates.

--

.footnote[
[1] Larremore, Daniel B., Bailey K. Fosdick, Sam Zhang, and Yonatan H. Grad. 2020. “Jointly Modeling Prevalence, Sensitivity and Specificity for Optimal Sample Allocation.” _bioRxiv_, May. https://doi.org/10.1101/2020.05.23.112649.

[2] Gelman, Andrew, and Bob Carpenter. 2020. “Bayesian Analysis of Tests with Unknown Specificity and Sensitivity.” _Journal of the Royal Statistical Society: Series C (Applied Statistics)_, August. https://doi.org/10.1111/rssc.12435.

[3] Andree Valle Campos. 2020. avallecam/serosurvey: Serological Survey Analysis For Prevalence Estimation Under Misclassification (Version v1.0.1). Zenodo. http://doi.org/10.5281/zenodo.4118710. https://avallecam.github.io/serosurvey
]


---

# 1/3: Estimate single prev.


```{r example,echo=FALSE,warning=FALSE,message=FALSE}
library(serosurvey)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
# additional
library(tidyverse)
library(srvyr)
library(survey)
library(tictoc)
library(furrr)
library(purrr)
# theme
theme_set(theme_bw())
```

```{r,echo=FALSE}
data(api)

datasurvey <- apiclus2 %>% 
  mutate(survey_all="survey_all") %>% 
  # create variables
  mutate(outcome_one = awards,
         outcome_two = cut(pct.resp,breaks = 2),
         covariate_01 = stype,
         covariate_02 = both)
```

```{r,echo=FALSE}
# tratamiento de stratos con un solo conglomerado
options(survey.lonely.psu = "certainty")

# uu_clean_data %>% count(CONGLOMERADO,VIVIENDA)

# diseño muestral de la encuesta ---------------------------------

design <- datasurvey %>% 
  
  filter(!is.na(outcome_one)) %>% #CRITICAL! ON OUTCOME
  filter(!is.na(pw)) %>% #NO DEBEN DE HABER CONGLOMERADOS SIN WEIGHT
  
  as_survey_design(
    id=c(dnum, snum), #~dnum+snum, # primary secondary sampling unit
    # strata = strata, #clusters need to be nested in the strata
    weights = pw # factores de expancion
  )
```

```{r,echo=FALSE}
# denominadores
covariate_set01 <- datasurvey %>% 
  select(covariate_01,
         #sch.wide,
         #comp.imp,
         covariate_02) %>% 
  colnames()

# numerators within outcome
covariate_set02 <- datasurvey %>% 
  select(#stype,
         #sch.wide,
         #comp.imp,
         covariate_02) %>% 
  colnames()
```


--

<!-- 1. `survey`: Estimate single prevalences -->

From a [`srvyr`](http://gdfe.co/srvyr/) __survey design object__, __`serosvy_proportion`__ estimates:

  + weighted prevalence (`prop`), 
  + total population (`total`),
  + raw proportion (`raw_prop`), 
  + coefficient of variability (`cv`), 
  + design effect (`deff`)

--


```{r}
serosvy_proportion(design = design,
                   denominator = covariate_01,
                   numerator = outcome_one)
```

```{r,eval=FALSE,echo=FALSE}
example("serosvy_proportion")
```

---

# 2/3: Estimate multiple prev.

--

- In 
the [Article tab](https://avallecam.github.io/serosurvey/articles/howto-reprex.html) 
we provide a workflow to __estimate multiple prevalences__: 

  + using different set of covariates and outcomes as numerators or denominators,
  + in one single pipe operation

--

```{r}
# crear matriz
  #
  # set 01 of denominator-numerator
  #
expand_grid(
  design=list(design),
  denominator=c("covariate_01","covariate_02"), # covariates
  numerator=c("outcome_one","outcome_two") # outcomes
  ) %>% 
  #
  # set 02 of denominator-numerator (e.g. within main outcome)
  #
  union_all(
    expand_grid(
      design=list(design),
      denominator=c("outcome_one","outcome_two"), # outcomes
      numerator=c("covariate_02") # covariates
    )
  ) %>% 
  #
  # create symbols (to be readed as arguments)
  #
  mutate(
    denominator=map(denominator,dplyr::sym),
    numerator=map(numerator,dplyr::sym)
  ) %>% 
  #
  # estimate prevalence
  #
  mutate(output=pmap(.l = select(.,design,denominator,numerator),
                     .f = serosvy_proportion)) %>% 
  #
  # show the outcome
  #
  select(-design,-denominator,-numerator) %>% 
  unnest(cols = c(output)) %>% 
  print(n=Inf)
```


---

# The `serosurvey` workflows

--

- bullet1

--

- bullet2

--

- bullet3

--

.footnote[
[1] 中文用户请看[这份教程](https://slides.yihui.org/xaringan/zh-CN.html)

[2] See [#2](https://github.com/yihui/xaringan/issues/2) if you do not see the template or addin in RStudio.
]


---

# Results

--

- bullet1

--

- bullet2

--

- bullet3

--

.footnote[
[1] 中文用户请看[这份教程](https://slides.yihui.org/xaringan/zh-CN.html)

[2] See [#2](https://github.com/yihui/xaringan/issues/2) if you do not see the template or addin in RStudio.
]


---

# Discussion

--

- bullet1

--

- bullet2

--

- bullet3

--

.footnote[
[1] 中文用户请看[这份教程](https://slides.yihui.org/xaringan/zh-CN.html)

[2] See [#2](https://github.com/yihui/xaringan/issues/2) if you do not see the template or addin in RStudio.
]

---

# Next steps

--

- Adjust to the RopenSci packaging guidelines

--

- Integrate it to the R Epidemic Consortium (RECON)

--

- Welcome new functions and workflows to the package!

--

.footnote[
[1] https://devguide.ropensci.org/building.html

[2] https://www.repidemicsconsortium.org/resources/guidelines/

[3] https://github.com/avallecam/serosurvey
]



---

class: center, middle

# Thanks for your attention! <br/> Happy to chat with you!

## <br/>Andree Valle Campos<br/><br/> `r icons::fontawesome$brands$twitter` `r icons::fontawesome$brands$github` __`@avallecam`__ <br/> `r icons::fontawesome$solid$inbox` __avallecam@gmail.com__

